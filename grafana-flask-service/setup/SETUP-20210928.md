

ssh root@172.21.144.60

FQDN for this?

password: Poly@5698

Configure SSH to permit root login

## Check HTTPD is running

[root@SR-Grafana-Dev-QA ~]# service httpd status
Redirecting to /bin/systemctl status httpd.service
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:httpd(8)
           man:apachectl(8)


[root@SR-Grafana-Dev-QA home]# ls -al
total 0
drwxr-xr-x.  3 root root  32 Sep 25 09:34 .
dr-xr-xr-x. 17 root root 244 Sep 24 14:58 ..
drwxr-xr-x   5 root root  68 Sep 25 09:35 Prod_flask_grafana
[root@SR-Grafana-Dev-QA home]# 

[root@SR-Grafana-Dev-QA Prod_flask_grafana]# ls -al
total 0
drwxr-xr-x  5 root root  68 Sep 25 09:35 .
drwxr-xr-x. 3 root root  32 Sep 25 09:34 ..
drwxr-xr-x  4 root root  54 Sep 25 09:34 Grafana_7.3.1
drwxr-xr-x  2 root root 202 Sep 25 09:35 Grafana_jsons
drwxr-xr-x  3 root root  38 Sep 25 09:35 Python_flask
[root@SR-Grafana-Dev-QA Prod_flask_grafana]# 


[root@SR-Grafana-Dev-QA Prod_flask_grafana]# cd Grafana_7.3.1/
[root@SR-Grafana-Dev-QA Grafana_7.3.1]# ls -al
total 0
drwxr-xr-x 4 root root 54 Sep 25 09:34 .
drwxr-xr-x 5 root root 68 Sep 25 09:35 ..
drwxr-xr-x 2 root root 25 Sep 25 09:34 use_share_grafana
drwxr-xr-x 3 root root 21 Sep 25 09:34 var_lib_grafana

Unzip 

[root@SR-Grafana-Dev-QA use_share_grafana]# ls -al
total 38828
drwxr-xr-x 3 root root       40 Sep 28 12:37 .
drwxr-xr-x 4 root root       54 Sep 25 09:34 ..
drwxr-xr-x 7 root root       96 Dec 18  2020 grafana
-rw-r--r-- 1 root root 39756781 Sep  4 13:46 grafana.zip


# Install modified Grafana (custom)

cd /usr/share 
mv grafana grafana-20210927

mv /home/Prod_flask_grafana/Grafana_7.3.1/use_share_grafana/grafana .

[root@SR-Grafana-Dev-QA share]# ls grafana*
grafana:
bin  conf  plugins-bundled  public  scripts  VERSION

grafana-20210927:
bin  conf  plugins-bundled  public  scripts  VERSION

# Install plugins

[root@SR-Grafana-Dev-QA share]# cd /var/lib/
[root@SR-Grafana-Dev-QA lib]# ls -al grafa*
total 504
drwxr-xr-x.  4 grafana grafana     50 Sep 28 12:37 .
drwxr-xr-x. 55 root    root      4096 Sep 22 10:48 ..
-rw-r-----   1 grafana grafana 512000 Sep 28 12:37 grafana.db
drwxr-xr-x   2 grafana grafana      6 Sep 28 12:07 plugins
drwx------   2 grafana grafana      6 Sep 28 12:07 png


[root@SR-Grafana-Dev-QA lib]# cd grafana/
[root@SR-Grafana-Dev-QA grafana]# ls -al
total 504
drwxr-xr-x.  4 grafana grafana     50 Sep 28 12:37 .
drwxr-xr-x. 55 root    root      4096 Sep 22 10:48 ..
-rw-r-----   1 grafana grafana 512000 Sep 28 12:37 grafana.db
drwxr-xr-x   2 grafana grafana      6 Sep 28 12:07 plugins
drwx------   2 grafana grafana      6 Sep 28 12:07 png

[root@SR-Grafana-Dev-QA plugins]# pwd
/var/lib/grafana/plugins


[root@SR-Grafana-Dev-QA plugins]# ls -al
total 0
drwxr-xr-x  2 grafana grafana  6 Sep 28 12:07 .
drwxr-xr-x. 4 grafana grafana 50 Sep 28 12:37 ..


It's empty

[root@SR-Grafana-Dev-QA plugins]# ls -al
total 8648
drwxr-xr-x  8 grafana grafana     267 Sep 28 12:45 .
drwxr-xr-x. 4 grafana grafana      50 Sep 28 12:37 ..
drwxr-xr-x  7 root    root        308 Sep 25 09:34 briangann-datatable-panel
drwxr-xr-x  4 root    root        215 Sep 25 09:34 cloudspout-button-panel
drwxr-xr-x  7 root    root        198 Sep 25 09:35 grafana-groupedbarchart-panel
-rw-r--r--  1 root    root    8852525 May 13 17:24 grafana-groupedbarchart-panel.1620906855.tar.gz
drwxr-xr-x  4 root    root        277 Sep 25 09:35 grafana-piechart-panel
drwxr-xr-x  3 root    root        175 Sep 25 09:35 marcusolsson-json-datasource
drwxr-xr-x  3 root    root        206 Sep 25 09:35 yesoreyeram-infinity-datasource

[root@SR-Grafana-Dev-QA plugins]# rm grafana-groupedbarchart-panel.1620906855.tar.gz 
rm: remove regular file ‘grafana-groupedbarchart-panel.1620906855.tar.gz’? y
[root@SR-Grafana-Dev-QA plugins]# ls -al
total 0
drwxr-xr-x  8 grafana grafana 212 Sep 28 12:45 .
drwxr-xr-x. 4 grafana grafana  50 Sep 28 12:37 ..
drwxr-xr-x  7 root    root    308 Sep 25 09:34 briangann-datatable-panel
drwxr-xr-x  4 root    root    215 Sep 25 09:34 cloudspout-button-panel
drwxr-xr-x  7 root    root    198 Sep 25 09:35 grafana-groupedbarchart-panel
drwxr-xr-x  4 root    root    277 Sep 25 09:35 grafana-piechart-panel
drwxr-xr-x  3 root    root    175 Sep 25 09:35 marcusolsson-json-datasource
drwxr-xr-x  3 root    root    206 Sep 25 09:35 yesoreyeram-infinity-datasource

# Configure Grafana to use MySQL database

[root@SR-Grafana-Dev-QA plugins]# cd /etc/grafana
[root@SR-Grafana-Dev-QA grafana]# ls -al
total 48
drwxr-xr-x.   3 root root       62 Sep 22 10:48 .
drwxr-xr-x. 138 root root     8192 Sep 25 09:08 ..
-rw-r-----.   1 root grafana 31236 Sep 22 10:48 grafana.ini
-rw-r-----.   1 root grafana  2289 Sep 22 10:48 ldap.toml
drwxr-xr-x.   6 root grafana    75 Sep 22 10:48 provisioning

`vim grafana.ini`
> NOTE: if not configure, Grafana will setup a new database

> NOTE: `/var/lib/grafana/grafana.db
```
#################################### Database ####################################
[database]
# You can configure the database connection by specifying type, host, name, user and password
# as separate properties or as on string using the url properties.

# Either "mysql", "postgres" or "sqlite3", it's your choice
;type = sqlite3
;host = 127.0.0.1:3306
;name = grafana
;user = root
type = mysql
host = 127.0.0.1:3306
name = grafanadb
user = root
# If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
;password =
password = Poly@5698
```

```
ls -al /var/lib/grafana/grafana.db
```


## Provision Grafana MySQL database

[root@SR-Grafana-Dev-QA grafana]# mysql -u root -p 
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 4
Server version: 10.1.48-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> 


```
MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| grafanadb          |
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
4 rows in set (0.00 sec)

MariaDB [(none)]> 

```

```
drop database grafanadb;
```

```
MariaDB [(none)]> create database grafanadb;
Query OK, 1 row affected (0.00 sec)
```

## Restart Grafana

```
[root@SR-Grafana-Dev-QA grafana]# service grafana-server status
● grafana-server.service - Grafana instance
   Loaded: loaded (/usr/lib/systemd/system/grafana-server.service; disabled; vendor preset: disabled)
   Active: active (running) since Tue 2021-09-28 12:07:03 IST; 47min ago
     Docs: http://docs.grafana.org
 Main PID: 8355 (grafana-server)
   CGroup: /system.slice/grafana-server.service
           └─8355 /usr/sbin/grafana-server --config=/etc/grafana/grafana.ini --pidfile=/var/run/grafana/grafana-server.pid --packaging=rpm cfg:default.path...

Sep 28 12:07:02 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:02+0530 lvl=info msg="Executing migration" logger=migrator id="create ca...a table"
Sep 28 12:07:02 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:02+0530 lvl=info msg="Executing migration" logger=migrator id="add uniqu...che_key"
Sep 28 12:07:02 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:02+0530 lvl=info msg="Executing migration" logger=migrator id="create sh...able v1"
Sep 28 12:07:02 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:02+0530 lvl=info msg="Executing migration" logger=migrator id="add index..._id-uid"
Sep 28 12:07:02 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:02+0530 lvl=info msg="Created default admin" logger=sqlstore user=admin
Sep 28 12:07:02 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:02+0530 lvl=info msg="Starting plugin search" logger=plugins
Sep 28 12:07:03 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:03+0530 lvl=info msg="Registering plugin" logger=plugins id=input
Sep 28 12:07:03 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:03+0530 lvl=info msg="External plugins directory created" logger=plugins.../plugins
Sep 28 12:07:03 SR-Grafana-Dev-QA systemd[1]: Started Grafana instance.
Sep 28 12:07:03 SR-Grafana-Dev-QA grafana-server[8355]: t=2021-09-28T12:07:03+0530 lvl=info msg="HTTP Server Listen" logger=http.server address=[::... socket=
Hint: Some lines were ellipsized, use -l to show in full.
```

check ports

 firewall-cmd --zone=public --permanent --add-port=80/tcp
 firewall-cmd --reload
 firewall-cmd --list-ports


running services and associated ports
```
[root@SR-Grafana-Dev-QA grafana]# netstat -tulpn
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      951/rpcbind         
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      8910/sshd           
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1605/master         
tcp6       0      0 :::3306                 :::*                    LISTEN      1427/mysqld         
tcp6       0      0 :::111                  :::*                    LISTEN      951/rpcbind         
tcp6       0      0 :::22                   :::*                    LISTEN      8910/sshd           
tcp6       0      0 :::3000                 :::*                    LISTEN      8355/grafana-server 
tcp6       0      0 ::1:25                  :::*                    LISTEN      1605/master         
udp        0      0 0.0.0.0:111             0.0.0.0:*                           951/rpcbind         
udp        0      0 0.0.0.0:675             0.0.0.0:*                           951/rpcbind         
udp6       0      0 :::111                  :::*                                951/rpcbind         
udp6       0      0 :::675                  :::*                                951/rpcbind   
```


[root@SR-Grafana-Dev-QA grafana]# service grafana-server restart
Restarting grafana-server (via systemctl):                 [  OK  ]


# Browse to http://172.21.144.60:3000/

Set password to `Poly@5698`

Set Light UI theme
Dashboards > Manage


```
[root@SR-Grafana-Dev-QA grafana]# cd /home/Prod_flask_grafana/
[root@SR-Grafana-Dev-QA Prod_flask_grafana]# ls -al
total 0
drwxr-xr-x  5 root root  68 Sep 25 09:35 .
drwxr-xr-x. 3 root root  32 Sep 25 09:34 ..
drwxr-xr-x  4 root root  54 Sep 25 09:34 Grafana_7.3.1
drwxr-xr-x  2 root root 202 Sep 25 09:35 Grafana_jsons
drwxr-xr-x  3 root root  38 Sep 25 09:35 Python_flask
[root@SR-Grafana-Dev-QA Prod_flask_grafana]# cd Grafana_jsons
[root@SR-Grafana-Dev-QA Grafana_jsons]# ls -al
total 400
drwxr-xr-x 2 root root    202 Sep 25 09:35 .
drwxr-xr-x 5 root root     68 Sep 25 09:35 ..
-rw-r--r-- 1 root root 161652 Sep  7 10:39 admin_all_drill_down.json
-rw-r--r-- 1 root root 146024 Sep  7 10:38 admin_dashboard.json
-rw-r--r-- 1 root root   9947 Sep  7 10:41 License_graph_utilizations.json
-rw-r--r-- 1 root root  25225 Sep  7 10:42 packet_loss_drill_down.json
-rw-r--r-- 1 root root   7930 Sep  7 10:43 port_graph_utilization_graph.json
-rw-r--r-- 1 root root  45913 Sep  7 10:44 reports.json
```


# Change IP address

[root@grafana-monitoring-demo ~]# cd /etc/sysconfig/network-scripts/
[root@grafana-monitoring-demo network-scripts]# 

[root@grafana-monitoring-demo network-scripts]# vim ifcfg-ens192

TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="none"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="ens192"
UUID="a4e8391b-d716-4e08-97dc-2ba99c00cc81"
DEVICE="ens192"
ONBOOT="yes"
IPADDR="172.21.144.56"
PREFIX="24"
GATEWAY="172.21.144.1"
DNS1="10.250.6.148"
IPV6_PRIVACY="no"


[root@grafana-monitoring-demo ~]# ifconfig
ens192: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.21.144.56  netmask 255.255.255.0  broadcast 172.21.144.255
        inet6 fe80::9644:5681:593d:339d  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:c9:c6:81  txqueuelen 1000  (Ethernet)
        RX packets 7472  bytes 598768 (584.7 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 9976  bytes 24221138 (23.0 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 465  bytes 188926 (184.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 465  bytes 188926 (184.4 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0




$ ssh root@salesdemo.rmm.poly.com
The authenticity of host 'salesdemo.rmm.poly.com (172.21.144.56)' can't be established.
ECDSA key fingerprint is SHA256:HOGZ1H72eZhWp+Vm/i3B98QyKWlZDcoERqxnH40u7KY.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'salesdemo.rmm.poly.com,172.21.144.56' (ECDSA) to the list of known hosts.
Last login: Wed Sep 29 10:37:29 2021 from 10.74.129.104
[root@grafana-monitoring-demo ~]# 


[root@grafana-monitoring-demo ~]# service grafana-server status
● grafana-server.service - Grafana instance
   Loaded: loaded (/usr/lib/systemd/system/grafana-server.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: http://docs.grafana.org

[root@grafana-monitoring-demo ~]# service grafana-server restart
Restarting grafana-server (via systemctl):                 [  OK  ]
[root@grafana-monitoring-demo ~]# service grafana-server status
● grafana-server.service - Grafana instance
   Loaded: loaded (/usr/lib/systemd/system/grafana-server.service; disabled; vendor preset: disabled)
   Active: active (running) since Wed 2021-09-29 10:43:33 IST; 4s ago
     Docs: http://docs.grafana.org
 Main PID: 2038 (grafana-server)
   CGroup: /system.slice/grafana-server.service
           └─2038 /usr/sbin/grafana-server --config=/etc/grafana/grafana.ini --pidfile=/var/run/grafana/grafana-server.pid --packaging=rpm cfg:default.path...

Sep 29 10:43:32 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:32+0530 lvl=info msg="Registering plugin" logger=plugins id=input
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=warn msg="Plugin file's signature has been modified ver...dule.js
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="Registering plugin" logger=plugins id=marcuso...asource
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="Registering plugin" logger=plugins id=yesorey...asource
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="Registering plugin" logger=plugins id=brianga...e-panel
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="Registering plugin" logger=plugins id=cloudsp...n-panel
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="Registering plugin" logger=plugins id=grafana...t-panel
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="Registering plugin" logger=plugins id=grafana...t-panel
Sep 29 10:43:33 grafana-monitoring-demo systemd[1]: Started Grafana instance.
Sep 29 10:43:33 grafana-monitoring-demo grafana-server[2038]: t=2021-09-29T10:43:33+0530 lvl=info msg="HTTP Server Listen" logger=http.server addres...socket=
Hint: Some lines were ellipsized, use -l to show in full.

browse to http://salesdemo.rmm.poly.com:3000/login 



/etc/grafana/grafana.ini

configure port
```
#################################### Server ####################################
[server]
# Protocol (http, https, h2, socket)
;protocol = http
protocol = https

# The ip address to bind to, empty will bind to all interfaces
;http_addr =

# The http port  to use
;http_port = 3000
http_port = 443
```

change path to certs
```
# https certs & key file
;cert_file =
;cert_key =
cert_file = /etc/pki/tls/certs/grafana-monitoring-demo.crt
cert_key = /etc/pki/tls/certs/grafana-monitoring-demo.key
```

```
[root@grafana-monitoring-demo certs]# ls -al
total 24
drwxr-xr-x. 2 root root  276 Sep 29 10:57 .
drwxr-xr-x. 5 root root   81 Sep  4 10:37 ..
lrwxrwxrwx. 1 root root   49 Sep  4 10:37 ca-bundle.crt -> /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
lrwxrwxrwx. 1 root root   55 Sep  4 10:37 ca-bundle.trust.crt -> /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt
-rw-r--r--  1 root root 1180 Jan 25  2021 grafana-monitoring-demo.crt
-rw-r--r--  1 root root 1679 Jan 25  2021 grafana-monitoring-demo.key
-rw-------. 1 root root 1403 Sep  3 14:59 localhost.crt
-rwxr-xr-x. 1 root root  610 Dec 17  2020 make-dummy-cert
-rw-r--r--. 1 root root 2516 Dec 17  2020 Makefile
-rwxr-xr-x. 1 root root  829 Dec 17  2020 renew-dummy-cert
lrwxrwxrwx  1 root root   27 Sep 29 10:56 salesdemo.rmm.poly.com.crt -> grafana-monitoring-demo.crt
lrwxrwxrwx  1 root root   27 Sep 29 10:57 salesdemo.rmm.poly.com.key -> grafana-monitoring-demo.key
```


/etc/grafana/grafana.ini 
set public facing URL
```
# The full public facing url you use in browser, used for redirects and emails
# If you use reverse proxy and sub path specify full url (with sub path)
;root_url = %(protocol)s://%(domain)s:%(http_port)s/
root_url = https://salesdemo.rmm.poly.com
```

```
[root@grafana-monitoring-demo grafana]# service grafana-server restart
Restarting grafana-server (via systemctl):                 [  OK  ]
```

If the following issue

```
# more /var/log/grafana/grafana.log | grep bind

t=2021-09-29T11:03:10+0530 lvl=eror msg="Stopped HTTPServer" logger=server reason="failed to open listener on address 0.0.0.0:443: listen tcp 0.0.0.0:443: bind: permission denied"
t=2021-09-29T11:03:11+0530 lvl=eror msg="A service failed" logger=server err="failed to open listener on address 0.0.0.0:443: listen tcp 0.0.0.0:443: bind: permission denied"
t=2021-09-29T11:03:11+0530 lvl=eror msg="Server shutdown" logger=server reason="failed to open listener on address 0.0.0.0:443: listen tcp 0.0.0.0:443: bind: permission denied"
t=2021-09-29T11:03:12+0530 lvl=eror msg="Stopped HTTPServer" logger=server reason="failed to open listener on address 0.0.0.0:443: listen tcp 0.0.0.0:443: bind: permission denied"
t=2021-09-29T11:03:12+0530 lvl=eror msg="A service failed" logger=server err="failed to open listener on address 0.0.0.0:443: listen tcp 0.0.0.0:443: bind: permission denied"
t=2021-09-29T11:03:12+0530 lvl=eror msg="Server shutdown" logger=server reason="failed to open listener on address 0.0.0.0:443: listen tcp 0.0.0.0:443: bind: permission denied"
```
then run

```
sudo setcap 'cap_net_bind_service=+ep' /usr/sbin/grafana-server
```


# Configure the backend

[root@grafana-monitoring-demo grafana]# service httpd status
Redirecting to /bin/systemctl status httpd.service
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:httpd(8)
           man:apachectl(8)

```
[root@grafana-monitoring-demo Python_flask]# ls -al
total 4
drwxr-xr-x  3 root root   38 Sep 25 09:35 .
drwxr-xr-x  5 root root   68 Sep 25 09:35 ..
drwxr-xr-x 12 root root 4096 Sep 25 09:36 var_www_downloadsReports
[root@grafana-monitoring-demo Python_flask]# pwd
/home/Prod_flask_grafana/Python_flask

```

move to `/var/www/downloadsReports

```
[root@grafana-monitoring-demo flask-service]# mv /home/Prod_flask_grafana/Python_flask/var_www_downloadsReports/*  .
[root@grafana-monitoring-demo flask-service]# ls -al
total 196
drwxr-xr-x  12 root root  4096 Sep 29 11:27 .
drwxr-xr-x.  5 root root    91 Sep 29 11:27 ..
-rw-r--r--   1 root root 57973 Jun  8 15:01 dashboard_drilldown.py
-rw-r--r--   1 root root  5284 Jun  8 15:01 dao.py
drwxr-xr-x   2 root root  4096 Sep 25 09:35 dashboard_report_queries
-rw-r--r--   1 root root 42485 Jun  8 15:01 data_query.py
-rw-r--r--   1 root root  1012 Jun  8 15:01 db_connection.py
drwxr-xr-x   2 root root  4096 Sep 25 09:36 drilldown_dashboard_data_query
drwxr-xr-x   3 root root   165 Sep 25 09:36 graphql
drwxr-xr-x   2 root root   302 Sep 25 09:36 graphql_dashboard_queries
drwxr-xr-x   2 root root   127 Sep 25 09:36 graphql_download_queries
drwxr-xr-x   2 root root   238 Sep 25 09:36 graphql_drilldown_dashboard_data_query
-rw-r--r--   1 root root 10412 Jun 14 12:45 polyApp.py
-rw-r--r--   1 root root   119 Jun  8 15:01 polyApp.wsgi
drwxr-xr-x   2 root root   268 Sep 25 09:36 __pycache__
drwxr-xr-x   5 root root  4096 Sep 25 09:36 report
drwxr-xr-x   2 root root  4096 Sep 25 09:36 report_queries
drwxr-xr-x   2 root root     6 Sep 25 09:36 saved_xls
-rw-r--r--   1 root root  7603 Jun  8 17:57 service.py
-rw-r--r--   1 root root 30980 Jun  9 11:26 dashboard_downloads_sql_helpers.py
-rw-r--r--   1 root root  2230 Jun  8 15:01 xls_writer.py
[root@grafana-monitoring-demo flask-service]# 

```

```
[root@grafana-monitoring-demo flask-service]# chown apache:apache report -R
[root@grafana-monitoring-demo flask-service]# chown apache:apache saved_xls -R
```

```
[root@grafana-monitoring-demo flask-service]# chmod 776 report
[root@grafana-monitoring-demo flask-service]# chmod 776 saved_xls
```

```
[root@grafana-monitoring-demo flask-service]# ls -al
total 196
drwxr-xr-x  12 root   root    4096 Sep 29 11:27 .
drwxr-xr-x.  5 root   root      91 Sep 29 11:27 ..
-rw-r--r--   1 root   root   57973 Jun  8 15:01 dashboard_drilldown.py
-rw-r--r--   1 root   root    5284 Jun  8 15:01 dao.py
drwxr-xr-x   2 root   root    4096 Sep 25 09:35 dashboard_report_queries
-rw-r--r--   1 root   root   42485 Jun  8 15:01 data_query.py
-rw-r--r--   1 root   root    1012 Jun  8 15:01 db_connection.py
drwxr-xr-x   2 root   root    4096 Sep 25 09:36 drilldown_dashboard_data_query
drwxr-xr-x   3 root   root     165 Sep 25 09:36 graphql
drwxr-xr-x   2 root   root     302 Sep 25 09:36 graphql_dashboard_queries
drwxr-xr-x   2 root   root     127 Sep 25 09:36 graphql_download_queries
drwxr-xr-x   2 root   root     238 Sep 25 09:36 graphql_drilldown_dashboard_data_query
-rw-r--r--   1 root   root   10412 Jun 14 12:45 polyApp.py
-rw-r--r--   1 root   root     119 Jun  8 15:01 polyApp.wsgi
drwxr-xr-x   2 root   root     268 Sep 25 09:36 __pycache__
drwxrwxrw-   5 apache apache  4096 Sep 25 09:36 report
drwxr-xr-x   2 root   root    4096 Sep 25 09:36 report_queries
drwxrwxrw-   2 apache apache     6 Sep 25 09:36 saved_xls
-rw-r--r--   1 root   root    7603 Jun  8 17:57 service.py
-rw-r--r--   1 root   root   30980 Jun  9 11:26 dashboard_downloads_sql_helpers.py
-rw-r--r--   1 root   root    2230 Jun  8 15:01 xls_writer.py
[root@grafana-monitoring-demo flask-service]# 

```


```
[root@grafana-monitoring-demo flask-service]# cd /etc/httpd/conf.d
```



[root@grafana-monitoring-demo conf.d]# pwd
/etc/httpd/conf.d
[root@grafana-monitoring-demo conf.d]# ls -al
total 44
drwxr-xr-x. 2 root root  182 Sep 29 11:37 .
drwxr-xr-x. 5 root root   92 Sep  4 10:38 ..
-rw-r--r--. 1 root root 2926 Nov 16  2020 autoindex.conf
-rw-r--r--. 1 root root  401 Aug  9  2019 fcgid.conf
-rw-r--r--  1 root root  521 Sep 29 11:37 grafana-monitoring.conf
-rw-r--r--. 1 root root  323 Nov 16  2020 manual.conf
-rw-r--r--. 1 root root  691 Apr  1  2020 php.conf
-rw-r--r--. 1 root root  366 Nov 16  2020 README
-rw-r--r--. 1 root root 9443 Nov 16  2020 ssl.conf
-rw-r--r--. 1 root root 1252 Nov 16  2020 userdir.conf
-rw-r--r--. 1 root root  824 Nov 16  2020 welcome.conf


`[root@grafana-monitoring-demo conf.d]# vim grafana-monitoring.conf`
```
<VirtualHost *:8443>
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rmm-dev.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rmm-dev.key
    ServerName salesdemo.rmm.poly.com
    WSGIScriptAlias /u /var/www/flask-service/polyApp.wsgi
    <Directory /var/www/flask-service/>
        Order allow,deny
        Allow from all
        Header set Access-Control-Allow-Origin "https://salesdemo.rmm.poly.com"
        Header set Access-Control-Allow-Credentials true
    </Directory>
    LogLevel info
</VirtualHost>
```


[root@grafana-monitoring-demo conf.d]# vim ssl.conf 
```
# When we also provide SSL we have to listen to the 
# the HTTPS port in addition.
#
# JOEL / SAMEER 20210928 Changed to 8443 because Grafana is already using 443
Listen 8443 https
```

```
[root@grafana-monitoring-demo flask-service]# vim polyApp.wsgi 

```
```
#!/usr/bin/python3
import sys
sys.path.insert(0,"/var/www/flask-service")      <==
from polyApp import app as application
```

```
[root@grafana-monitoring-demo flask-service]# service httpd restart
Redirecting to /bin/systemctl restart httpd.service
```

it's running 

```
[root@grafana-monitoring-demo flask-service]# service httpd status
Redirecting to /bin/systemctl status httpd.service
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: active (running) since Wed 2021-09-29 11:42:08 IST; 14s ago
     Docs: man:httpd(8)
           man:apachectl(8)
 Main PID: 2878 (httpd)
   Status: "Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec"
   CGroup: /system.slice/httpd.service
           ├─2878 /usr/sbin/httpd -DFOREGROUND
           ├─2879 /usr/sbin/httpd -DFOREGROUND
           ├─2880 /usr/sbin/httpd -DFOREGROUND
           ├─2881 /usr/sbin/httpd -DFOREGROUND
           ├─2882 /usr/sbin/httpd -DFOREGROUND
           ├─2883 /usr/sbin/httpd -DFOREGROUND
           └─2884 /usr/sbin/httpd -DFOREGROUND

Sep 29 11:42:06 grafana-monitoring-demo systemd[1]: Starting The Apache HTTP Server...
Sep 29 11:42:07 grafana-monitoring-demo httpd[2878]: AH00558: httpd: Could not reliably determine the server's fully qualified domain name, using fe80::9644:...s message
Sep 29 11:42:08 grafana-monitoring-demo systemd[1]: Started The Apache HTTP Server.
Hint: Some lines were ellipsized, use -l to show in full.
```

add 8443

[root@grafana-monitoring-demo flask-service]#  firewall-cmd  --list-ports
443/tcp 3000/tcp 5000/tcp 7706/tcp 9000/tcp
[root@grafana-monitoring-demo flask-service]#  firewall-cmd --zone=public --permanent --add-port=8443/tcp
success
[root@grafana-monitoring-demo flask-service]#  firewall-cmd  --list-ports
443/tcp 3000/tcp 5000/tcp 7706/tcp 9000/tcp
[root@grafana-monitoring-demo flask-service]#  firewall-cmd --reload
success
[root@grafana-monitoring-demo flask-service]#  firewall-cmd  --list-ports
443/tcp 3000/tcp 5000/tcp 7706/tcp 9000/tcp 8443/tcp
[root@grafana-monitoring-demo flask-service]# 

# Prerequisites
## install python 3
[root@grafana-monitoring-demo flask-service]# python --version
Python 2.7.5
[root@grafana-monitoring-demo flask-service]# python3 --version
-bash: python3: command not found

```
[root@grafana-monitoring-demo flask-service]# yum install python3 
```

```
[root@grafana-monitoring-demo flask-service]# python3 --version
Python 3.6.8

```
yum install epel-release centos-release-scl 
yum install python36 python36-devel httpd httpd-devel rh-python36-mod_wsgi
```

install mod for Apache
```
rpm -ql rh-python36-mod_wsgi
```


```
[root@grafana-monitoring-demo flask-service]# ls -al /opt/rh/httpd24/root/etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf 
-rw-r--r-- 1 root root 55 Oct 24  2017 /opt/rh/httpd24/root/etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf
[root@grafana-monitoring-demo flask-service]# ls -al /opt/rh/httpd24/root/usr/lib64/httpd/modules/mod_rh-python36-wsgi.so  
-rwxr-xr-x 1 root root 244184 Oct 24  2017 /opt/rh/httpd24/root/usr/lib64/httpd/modules/mod_rh-python36-wsgi.so

```

Create symbolic links 

```
[root@grafana-monitoring-demo flask-service]# ln -s /opt/rh/httpd24/root/etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf  /etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf
[root@grafana-monitoring-demo flask-service]# ls -al /etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf 
lrwxrwxrwx 1 root root 70 Sep 29 11:54 /etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf -> /opt/rh/httpd24/root/etc/httpd/conf.modules.d/10-rh-python36-wsgi.conf
[root@grafana-monitoring-demo flask-service]# ln -s /opt/rh/httpd24/root/usr/lib64/httpd/modules/mod_rh-python36-wsgi.so /etc/httpd/modules/mod_rh-python36-wsgi.so   
[root@grafana-monitoring-demo flask-service]# ls -al /etc/httpd/modules/mod_rh-python36-wsgi.so  
lrwxrwxrwx 1 root root 68 Sep 29 11:54 /etc/httpd/modules/mod_rh-python36-wsgi.so -> /opt/rh/httpd24/root/usr/lib64/httpd/modules/mod_rh-python36-wsgi.so
[root@grafana-monitoring-demo flask-service]# 

```

# Python modules

```
certifi==2021.5.30
charset-normalizer==2.0.4
click==8.0.1
dataclasses==0.8
et-xmlfile==1.1.0
Flask==2.0.1
Flask-Cors==3.0.10
idna==3.2
importlib-metadata==4.8.1
itsdangerous==2.0.1
Jinja2==3.0.1
MarkupSafe==2.0.1
numpy==1.19.5
openpyxl==3.0.7
pandas==1.1.5
PyMySQL==1.0.2
python-dateutil==2.8.2
pytz==2021.1
requests==2.26.0
semantic-version==2.8.5
setuptools-rust==0.12.1
six==1.16.0
toml==0.10.2
typing-extensions==3.10.0.2
urllib3==1.26.6
Werkzeug==2.0.1
XlsxWriter==3.0.1
zipp==3.5.0
```

[root@grafana-monitoring-demo flask-service]# pip3 install -r requirements.txt 

[root@grafana-monitoring-demo flask-service]# service httpd restart
Redirecting to /bin/systemctl restart httpd.service

[root@grafana-monitoring-demo grafana]# tail -f /var/log/httpd/error_log
[Wed Sep 29 12:03:49.367467 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606] Traceback (most recent call last):
[Wed Sep 29 12:03:49.367515 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]   File "/var/www/flask-service/polyApp.wsgi", line 4, in <module>
[Wed Sep 29 12:03:49.367523 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]     from polyApp import app as application
[Wed Sep 29 12:03:49.367534 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]   File "/var/www/flask-service/polyApp.py", line 4, in <module>
[Wed Sep 29 12:03:49.367540 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]     from service import Service
[Wed Sep 29 12:03:49.367550 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]   File "/var/www/flask-service/service.py", line 39, in <module>
[Wed Sep 29 12:03:49.367555 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]     _token = get_security_token()
[Wed Sep 29 12:03:49.367565 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]   File "/var/www/flask-service/service.py", line 29, in get_security_token
[Wed Sep 29 12:03:49.367571 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606]     f = open("/etc/grafana/grafana.ini", "r", encoding='utf-8')
[Wed Sep 29 12:03:49.367593 2021] [wsgi:error] [pid 3364] [client 10.146.128.88:62606] PermissionError: [Errno 13] Permission denied: '/etc/grafana/grafana.ini'

fix permission on grafana.ini

[root@grafana-monitoring-demo grafana]# chmod 776 grafana.ini 
[root@grafana-monitoring-demo grafana]# service httpd resttart

Test that flask is running 

https://salesdemo.rmm.poly.com:8443/u/test

you will observe 
{"message":"Test Connection","status":"success"}

Change database config

db_connection.py
```python
import pymysql


class DBConnection:
    def test(self):
        print("pass")

    @classmethod
    def getDbConnection(cls):
        try:
            host_name = "172.21.144.23"
            user = "root"
            password = "em7admin"
            db_name = "master_dev"
           # print(host_name, user, password, db_name)
            dbConnection = pymysql.connect(db=db_name, user=user, passwd=password, host=host_name, port=7706)
            #print("DB connection successfully established")
            return dbConnection
        except Exception as e:
           pass

    @classmethod
    def get_grafana_DbConnection(cls):
        try:
            host_name = "localhost"
            user = "root"
            password = "Poly@5698"
            db_name = "grafanadb"
            dbConnection = pymysql.connect(db=db_name, user=user, passwd=password, host=host_name)
            return dbConnection
        except Exception as e:
            pass
```


